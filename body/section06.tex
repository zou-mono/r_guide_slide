
%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
\section{空间数据绘图系统}

\begin{frame}[c]{\subsecname}{}
      \begin{ornamentblock}%\hspace*{\parindent}
\hspace*{2em}我们借助于外感官（我们意识的一种性质）表象给我们自己外面的对象，这些对
象毫无例外的在空间里面。这些对象的形状、大小、以及它们相互间的关系是在
空间里被规定的或能够在空间里被规定的。\\
\hspace*{2em}空间不是一个从外部经验得来的经验概念。因为为使着某种感觉与我以外的某些
东西发生关系，以及同样地为着我能把那些感觉表象为互相在外、互相靠近，从
而不只是彼此不同，并且是在不同的地方，这样就一定要以空间观念为前提。\\
          \rightline{\textemdash《康德·纯粹理性批判》}
      \end{ornamentblock}
\end{frame}

\subsection{GIS和R}
\begin{frame}[t]{\subsecname}{}
\begin{itemize}
\item GIS的非正式定义\footnotemark[1]：一组强大的工具集，可以用来收集、存储、任意检索、转换和
显示\emphText{来自真实世界有特殊用途的空间数据}
\item R虽然能够分析并提供数据可视化，但是并没有能力从其他数据中区分出空间数据；因此一组R开发者共同
实现了R的\emphText{空间数据类包sp}\footnotemark[2]，它新增了用于空间数据类和方法的R功能
\end{itemize}

\only<2>{
\begin{block}{\small 空间数据类的优势}
  \begin{itemize} \footnotesize
  \item[\PencilLeftDown] 从空间分析包中转换数据更加容易
  \item[\PencilLeftDown] 提供GIS接口包，可以读写外部GIS格式数据
  \item[\PencilLeftDown] 实现空间数据组织、绘图、打印的方法
  \item[\PencilLeftDown] 能够对绘图进行地图修饰(参考网格、指北针、比例尺)
  \end{itemize}
\end{block}}

\footnotetext[1]{
Burrough, P. A. and McDonnell, R. A. (1998). \emph{Principles of Geographical
Information Systems}. Oxford University Press, Oxford.}
\footnotetext[2]{
Pebesma, E. J. and Bivand, R. S. (2005). \emph{Classes and methods for spatial
data in R}. R News, 5(2):9–13.}
\end{frame}

\subsection{R的空间数据类}
\begin{frame}[t]{\subsecname}{}
\begin{itemize}
\item<1-> sp包从2005年开始提交CRAN，主要创始人是挪威经济学院教授
\href{https://www.nhh.no/en/employees/faculty/roger-bivand/}{\uline{Roger Bivand}}和
慕尼黑大学教授\href{https://www.uni-muenster.de/Geoinformatics/en/institute/staff/index.php/119/Edzer_Pebesma}{\uline{Edzer Pebesma}}；目前项目负责人是Edzer，并有稳定的开发团队和成熟的讨论组
\item<2-> sp包未包含在base包中，需要单独下载使用
\item<3-> 目前绝大多数空间数据相关的包都会以sp包为基础来编写
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\only<1>{
\begin{figure}
\begin{columns}
    \begin{column}{.5\textwidth}\centering
        \includegraphics[width=0.7\columnwidth]{roger_bivand.jpg}
    \end{column}

    \begin{column}{.5\textwidth}\centering
        \includegraphics[width=0.55\columnwidth]{edzer_pebesma.jpg}
    \end{column}
  \end{columns}
\caption{sp包的两位主要作者.左边是Roger Bivand,右边是Edzer Pebesma}
\end{figure}}

\only<3>{
\begin{figure}
    \centering
    \includegraphics[width=0.8\columnwidth]{sp_depend.png}
    \caption{直接或间接基于sp包开发的程序包}
\end{figure}}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{}
\begin{itemize}
\item<1-> sp包提供的空间类是\emphText{基于S4方法编写的}，其\emphText{基类是Spatial}
\item<2-> Spatial类包括两个属性(slot)，一个是matrix类型的\emphText{约束盒}(bbox)，
另一个是CRS类型的\emphText{坐标参考系统}(proj4string)
\item<3-> 约束盒是列名为\emphText{c('min','max')}的坐标矩阵，至少有两列，一列指向东（x轴），一列
指向北（y轴）；CRS类只有一个属性，其值是一个\emphText{\href{http://proj4.org/}{\uline{PROJ.4}}开源CRS格式的字符串}
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<2>
\begin{rcode}
> library(sp)
> getClass("Spatial")
Class "Spatial" [package "sp"]

Slots:
                              
Name:         |\colorbox{green}{bbox}| |\colorbox{green}{proj4string}|
Class:      matrix         CRS

Known Subclasses: 
Class "SpatialPoints", directly
Class "SpatialMultiPoints", directly
Class "SpatialGrid", directly
Class "SpatialLines", directly
Class "SpatialPolygons", directly
Class "SpatialPointsDataFrame", by class "SpatialPoints", distance 2
Class "SpatialPixels", by class "SpatialPoints", distance 2
Class "SpatialMultiPointsDataFrame", by class "SpatialMultiPoints", distance 2
Class "SpatialGridDataFrame", by class "SpatialGrid", distance 2
Class "SpatialLinesDataFrame", by class "SpatialLines", distance 2
Class "SpatialPixelsDataFrame", by class "SpatialPoints", distance 3
Class "SpatialPolygonsDataFrame", by class "SpatialPolygons", distance 2
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{rcode}
# 定义约束盒
> bb <- matrix(c(114.25, 22.45, 114.85, 23.16), ncol = 2, dimnames = list(NULL, c("min", "max")))
# 新建一个Spatial对象，CRS对象是经纬度坐标系统
> Spatial(bb, proj4string = CRS("+proj=longlat"))
An object of class "Spatial"
Slot "bbox":
        min    max
[1,] 114.25 114.85
[2,]  22.45  23.16

Slot "proj4string":
CRS arguments: +proj=longlat
\end{rcode}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\subsubsection{空间点类}
\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> 空间点在GIS中是一个坐标向量，sp包中定义\emphText{SpatialPoints}类来表达空间点
\item<2-> 相比Spatial类，SpatialPoints类扩展了一个matrix类型的属性\emphText{coords}来存储点坐标矩阵
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<2->
\begin{rcode}
> getClass("SpatialPoints")
Class "SpatialPoints" [package "sp"]

Slots:
                                          
Name:       |\colorbox{green}{coords}|        bbox proj4string
Class:      matrix      matrix         CRS

Extends: "Spatial"

Known Subclasses: 
Class "SpatialPointsDataFrame", directly
Class "SpatialPixels", directly
Class "SpatialPixelsDataFrame", by class "SpatialPixels", distance 2
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{rcode}
# 读取格式化文件到一个data.frame类型对象CRAN\_df,包含位置经纬度坐标
> CRAN_df <- read.table("data/CRAN051001a.txt", header = TRUE)
# 将经纬度坐标构建一个新的matrix类型对象CRAN\_mat
> CRAN_mat <- cbind(CRAN_df$long, CRAN_df$lat)

# 构建一个CRS对象llCRS 
llCRS <- CRS("+proj=longlat +ellps=WGS84")
# 构建SpatialPoints对象
CRAN_sp <- |\colorbox{green}{SpatialPoints}|(CRAN_mat, proj4string = llCRS)
\end{rcode}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> \emphText{SpatialPointsDataFrame}类将SpatialPoints对象转换为类似data.frame数据结构
\item<2-> SpatialPointsDataFrame类通过coords行名和data.frame行名的对应顺序来构建，
\emphText{可以用于在空间信息后面挂载属性信息}
\item<4-> SpatialPointsDataFrame对象有两个索引，一个用于空间对象，另一个用于列
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{rcode}
> getClass("SpatialPointsDataFrame")
Class "SpatialPointsDataFrame" [package "sp"]

Slots:                                                                  

Name:         data  coords.nrs      coords        bbox proj4string
Class:  data.frame     numeric      matrix      matrix         CRS

Extends: 
Class "SpatialPoints", directly
Class "Spatial", by class "SpatialPoints", distance 2
\end{rcode}
\begin{figure}[ht]\vspace{-10pt}
  \includegraphics[width=0.6\columnwidth]{spatialpointsdataframe_class.png}
\end{figure}
\end{onlyenv}

\begin{onlyenv}<2>
\begin{rcode}
# 将matrix的序号作为行名
> row.names(CRAN_mat) <- 1:nrow(CRAN_mat)
> str(CRAN_mat)
 num [1:54, 1:2] 153 145 16.3 -49.3 -42.9 ...
 - attr(*, "dimnames")=List of 2
  ..$ : chr [1:54] "1" "2" "3" "4" ...
  ..$ : NULL

# 构建Spatialpoints对象CRAN\_spdf1,match.ID=TURE表示根据CRAN\_mat行名和CRAN\_df行名要对应
> CRAN_spdf1 <- |\colorbox{green}{SpatialPointsDataFrame}|(coords=CRAN_mat, data=CRAN_df, proj4string=llCRS, match.ID=TRUE)
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{rcode}
# 构建的新对象在空间信息基础上挂载了属性信息long、lat、place、north、east和loc
> str(CRAN_spdf1)
Formal class 'SpatialPointsDataFrame' [package "sp"] with 5 slots
  ..@ data       :'data.frame': 54 obs. of  6 variables:
  .. ..$ place: Factor w/ 52 levels "Aalborg","Aizu",..: 9 30 50 15 49 39 36 40 12 46 ...
  .. ..$ north: Factor w/ 52 levels "20d45'S","22d43'S",..: 8 18 41 7 1 3 2 4 43 29 ...
  .. ..$ east : Factor w/ 51 levels "0d10'W","118d15'W",..: 19 16 20 35 31 32 34 33 11 39 ...
  .. ..$ loc  : Factor w/ 30 levels "Australia","Austria",..: 1 1 2 3 3 3 3 3 4 19 ...
  .. ..$ long : num [1:54] 153 145 16.3 -49.3 -42.9 ...
  .. ..$ lat  : num [1:54] -27.5 -37.8 48.2 -25.4 -20.8 ...
  ..@ coords.nrs : num(0) 
  ..@ coords     : num [1:54, 1:2] 153 145 16.3 -49.3 -42.9 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:54] "1" "2" "3" "4" ...
  .. .. ..$ : chr [1:2] "coords.x1" "coords.x2"
  ..@ bbox       : num [1:2, 1:2] -123 -37.8 153 57
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:2] "coords.x1" "coords.x2"
  .. .. ..$ : chr [1:2] "min" "max"
  ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
  .. .. ..@ projargs: chr "+proj=longlat +ellps=WGS84"  
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<4>
\begin{rcode}
% # 根据序号进行空间对象索引
> CRAN_spdf1[10, ]
          coordinates   place   north    east           loc      long   lat
10 (-79.38333, 43.65) Toronto 43d39'N 79d23'W Ontario (CAN) -79.38333 43.65

# 根据列进行索引,用法和data.frame类型的列索引一样，有两种等价的方法
> str(CRAN_spdf1$loc)
 Factor w/ 30 levels "Australia","Austria",..: 1 1 2 3 3 3 3 3 4 19 ...
> str(CRAN_spdf1[["loc"]])
Factor w/ 30 levels "Australia","Austria",..: 1 1 2 3 3 ...
\end{rcode}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{minipage}{\textwidth}
\begin{rcode}
% > str(turtle_sp)
Formal class 'SpatialPointsDataFrame' [package "sp"] with 5 slots
  ..@ data       :'data.frame': 394 obs. of  3 variables:
  .. ..$ id       : int [1:394] 1 2 3 4 5 6 7 8 9 10 ...
  .. ..$ obs_date : Factor w/ 394 levels "01/02/1997 04:16:53",..: 216 225 226 227 228 229 230 231 232 233 ...
  .. ..$ timestamp: POSIXct[1:394], format: "1996-08-11 01:15:00" "1996-08-17 15:18:23" ...
  ..@ coords.nrs : int [1:2] 3 2
  ..@ coords     : num [1:394, 1:2] 246 244 244 244 244 ...
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:394] "366" "367" "368" "369" ...
  .. .. ..$ : chr [1:2] "lon" "lat"
  ..@ bbox       : num [1:2, 1:2] 140.9 21.6 245.8 39.8
  .. ..- attr(*, "dimnames")=List of 2
  .. .. ..$ : chr [1:2] "lon" "lat"
  .. .. ..$ : chr [1:2] "min" "max"
  ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
  .. .. ..@ projargs: chr "+proj=longlat +ellps=WGS84"
\end{rcode}
\end{minipage}
\end{onlyenv}

\begin{onlyenv}<2>
\begin{minipage}{\textwidth}
\begin{rcode}
% > head(turtle_sp,15)
          coordinates id            obs_date           timestamp
366 (245.763, 28.668)  1 08/11/1996 01:15:00 1996-08-11 01:15:00
367 (244.427, 28.365)  2 08/17/1996 15:18:23 1996-08-17 15:18:23
368   (244.38, 28.26)  3 08/18/1996 14:57:44 1996-08-18 14:57:44
369 (244.323, 28.252)  4 08/18/1996 16:34:26 1996-08-18 16:34:26
370 (244.441, 28.185)  5 08/19/1996 14:31:33 1996-08-19 14:31:33
371 (244.235, 28.168)  6 08/19/1996 16:14:17 1996-08-19 16:14:17
372 (244.074, 28.171)  7 08/20/1996 14:12:10 1996-08-20 14:12:10
373 (244.104, 28.133)  8 08/20/1996 15:54:27 1996-08-20 15:54:27
374 (243.578, 27.361)  9 08/22/1996 15:11:14 1996-08-22 15:11:14
375 (243.282, 27.004) 10 08/23/1996 16:28:05 1996-08-23 16:28:05
237 (242.991, 26.876) 11 08/24/1996 14:28:13 1996-08-24 14:28:13
238  (242.947, 26.84) 12 08/24/1996 16:05:20 1996-08-24 16:05:20
239  (242.919, 26.83) 13 08/24/1996 20:00:25 1996-08-24 20:00:25
240 (242.874, 26.781) 14 08/25/1996 03:18:47 1996-08-25 03:18:47
241 (242.676, 26.762) 15 08/25/1996 15:41:11 1996-08-25 15:41:11
\end{rcode}
\end{minipage}
\end{onlyenv}

\begin{minipage}{\textwidth}
\centering
\includegraphics[width=0.7\columnwidth]{spatial_points_example.pdf}
\end{minipage}
\end{overlayarea}
\end{frame}

\subsubsection{空间线类}
\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> GIS中线对象是点对象的集合，在sp包中用\emphText{Line}类来表达；
而Line的集合又构成\emphText{Lines}类，其中不同Line通过NA值来区分
\item<2-> 但是Line和Lines不包含约束盒和坐标系统，所以sp包提供\emphText{SpatialLines}类用来专门表达空间线对象
\item<2-> SpatialLines类继承自Spatial类，除bbox和CRS之外，
还扩展了一个list类型的属性\emphText{lines}用来存储Lines对象
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{rcode}
% # Line类包含属性coords用来存储构成线的连续点坐标矩阵
> getClass("Line")
Class "Line" [package "sp"]

Slots:
             
Name:  |\colorbox{green}{coords}|
Class: matrix

Known Subclasses: "Polygon"

# Lines类包含一个属性Lines用来存储一系列Line对象，另一个属性ID用来标识Line对象的唯一性
> getClass("Lines")
Class "Lines" [package "sp"]

Slots:
                          
Name:      |\colorbox{green}{Lines}|        |\colorbox{green}{ID}|
Class:      list character
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<2>
\begin{rcode}
% > getClass("SpatialLines")
Class "SpatialLines" [package "sp"]

Slots:
                                          
Name:        |\colorbox{green}{lines}|        bbox proj4string
Class:        list      matrix         CRS

Extends: "Spatial"

Known Subclasses: "SpatialLinesDataFrame"
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{rcode}
% > library(maps)
# 获取中国地图
> china<- map("world", "china", plot=FALSE)
# 台湾是中国领土不可分割的一部分！
> tw <- map("world","taiwan",plot=FALSE)
> china$x <- c(china$x,NA,tw$x)
> china$y <- c(china$y,NA,tw$y)
> china$range <- c(range(china$range[1:2],tw$range[1:2]),range(china$range[3:4],tw$range[3:4]))
> china$names <- c(china$names,tw$names)
> p4s <- CRS("+proj=longlat +ellps=WGS84")
> library(maptools)
# 用map2SpatialLines将地图数据转换为SpatialLines对象
> SLchina <- |\colorbox{green}{map2SpatialLines}|(china,proj4string=p4s)
> str(SLchina, max.level=2)
Formal class 'SpatialLines' [package "sp"] with 3 slots
  ..@ lines      :List of 41  # 由41个line对象组成
  ..@ bbox       : num [1:2, 1:2] 73.6 18.2 134.8 53.6
  .. ..- attr(*, "dimnames")=List of 2
  ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<4>
\begin{figure}[ht] \vspace{-15pt}
  \includegraphics[width=0.8\columnwidth]{spatial_lines_example1.pdf}
\end{figure}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> 类似空间点，sp包提供\emphText{SpatialLinesDataFrame}类将SpatialLines对象转换为类似data.frame数据结构，用于挂载属性数据
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{rcode}
% > getClass("SpatialLinesDataFrame")
Class "SpatialLinesDataFrame" [package "sp"]

Slots:
                                                      
Name:         data       lines        bbox proj4string
Class:  data.frame        list      matrix         CRS

Extends: 
Class "SpatialLines", directly
Class "Spatial", by class "SpatialLines", distance 2
\end{rcode}
\begin{figure}[ht] 
  \includegraphics[width=0.7\columnwidth]{spatiallinesdataframe_class.png}
\end{figure}
\end{onlyenv}

\begin{onlyenv}<2>
\begin{rcode}
% # maptools包中的ContourLines2SLDF函数将contourLines返回值转换为SpatialLinesDataFrame对象
> volcano_sl <- ContourLines2SLDF(contourLines(volcano))
# volcano\_sl的data slot包含10个不同的等高线水平标签
> t(volcano_sl@data)
      C_1   C_2   C_3   C_4   C_5   C_6   C_7   C_8   C_9   C_10 
level "100" "110" "120" "130" "140" "150" "160" "170" "180" "190"
\end{rcode}
\begin{figure}[ht] \vspace{-10pt}
  \includegraphics[width=0.8\columnwidth]{spatial_lines_example2.pdf}
\end{figure}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\subsubsection{空间面类}
\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> 在GIS中面是一个封闭的环(ring)，用起始和终止坐标相同的点集存储，sp包定义\emphText{Polygon}类来表示面；一系列面对象构成\emphText{Polygons}类，其中不同Polygon通过NA值来区分
\item<2-> 在面对象基础上，sp包继承Spatial类定义\emphText{SpatialPolygons}类来表达空间面对象，使其具有bbox和CRS
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{rcode}
% # Polygon类包含属性coords用来存储起始和终止坐标相同的点坐标矩阵
> getClass("Polygon")
Class "Polygon" [package "sp"]

Slots:
                                              
Name:    labpt    area    hole ringDir  |\colorbox{green}{coords}|
Class: numeric numeric logical integer  matrix

Extends: "Line"

# Polygons类包含一个属性Polygons用来存储一系列Polygon对象，另一个属性ID用来标识Polygon对象的唯一性
> getClass("Polygons")
Class "Polygons" [package "sp"]

Slots:
                                                        
Name:   Polygons plotOrder     labpt        ID      area
Class:      list   integer   numeric character   numeric
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<2>
\begin{rcode}
% > getClass("SpatialPolygons")
Class "SpatialPolygons" [package "sp"]

Slots:
                                                      
Name:     polygons   plotOrder        bbox proj4string
Class:        list     integer      matrix         CRS

Extends: "Spatial", "SpatialPolygonsNULL"

Known Subclasses: 
Class "SpatialPolygonsDataFrame", directly, with explicit coerce
\end{rcode}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> sp包提供\emphText{SpatialPolygonsDataFrame}类将SpatialPolygons对象转换为类似data.frame数据结构，用于挂载属性数据
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{rcode}
% > getClass("SpatialPolygonsDataFrame")
Class "SpatialPolygonsDataFrame" [package "sp"]

Slots:
                                                                  
Name:         data    polygons   plotOrder        bbox proj4string
Class:  data.frame        list     integer      matrix         CRS

Extends: 
Class "SpatialPolygons", directly
Class "Spatial", by class "SpatialPolygons", distance 2
Class "SpatialPolygonsNULL", by class "SpatialPolygons", distance 2, with explicit coerce
\end{rcode}
\begin{figure}[ht] \vspace{-10pt}
  \includegraphics[width=0.7\columnwidth]{spatialpolygonsdataframe_class.png}
\end{figure}
\end{onlyenv}

\begin{onlyenv}<2>
\begin{rcode}
% # 从maps包中读取美国州边界地图
> library(maps)
> state.map <- map("state", plot=FALSE, fill=TRUE)
> IDs <- sapply(strsplit(state.map$names, ":"), function(x) x[1])
> library(maptools)
> state.sp <- map2SpatialPolygons(state.map, IDs=IDs,
      proj4string=CRS("+proj=longlat +ellps=WGS84"))

# 读取属性数据文件
> sat <- read.table("data/state.sat.data_mod.txt", row.names=5, header=TRUE)
# 属性数据包括四个字段
> str(sat)
'data.frame':   52 obs. of  4 variables:
 $ oname : Factor w/ 52 levels "ala","alaska",..: 1 2 3 4 5 6 7 9 8 10 ...
 $ vscore: int  561 516 524 563 497 536 510 503 494 499 ...
 $ mscore: int  555 514 525 556 514 540 509 497 478 498 ...
 $ pc    : int  9 50 34 6 49 32 80 67 77 53 ...
# 为属性数据添加ID字段，用于和空间对象进行关联
> id <- match(row.names(sat), row.names(state.sp))
> row.names(sat)[is.na(id)]
> sat1 <- sat[!is.na(id),]
# 创建SpatialPolygonsDataFrame对象
> state.spdf <- SpatialPolygonsDataFrame(state.sp, sat1)
> str(state.spdf, max.level=2)
Formal class 'SpatialPolygonsDataFrame' [package "sp"] with 5 slots
  ..@ data       :'data.frame': 49 obs. of  4 variables:
  ..@ polygons   :List of 49
  ..@ plotOrder  : int [1:49] 42 25 4 30 27 2 5 49 36 22 ...
  ..@ bbox       : num [1:2, 1:2] -124.7 25.1 -67 49.4
  .. ..- attr(*, "dimnames")=List of 2
  ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3> \centering
\begin{columns} 
    \begin{column}{.4\textwidth} 
        \includegraphics[width=\columnwidth]{spatial_polygons_example1.pdf}
    \end{column}

    \begin{column}{.6\textwidth}
\begin{rcode} 
% # 从SpatialPolygonsDataFrame对象中取得特定的数据
> california <- state.spdf[state.spdf$oname== "calif",]
> str(california,max.level=2)
Formal class 'SpatialPolygonsDataFrame' [package "sp"] with 5 slots
  ..@ data       :'data.frame': 1 obs. of  4 variables:
  ..@ polygons   :List of 1
  ..@ plotOrder  : int 1
  ..@ bbox       : num [1:2, 1:2] -124.4 32.5 -114.1 42
  .. ..- attr(*, "dimnames")=List of 2
  ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
> california@data
           oname vscore mscore pc
california calif    497    514 49
\end{rcode}
    \end{column}
  \end{columns}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> 在地理实体中，除了岛(island)这种简单的面对象之外，还存在洞(hole)这种特殊的面对象，在sp包中
简单通过\emphText{逻辑标记hole}定义面对象是否是洞
\item<1-> 如果hole没有指定，那么可以通过\emphText{ringDir}属性来判定环的方向，1表示顺时针则是岛，-1表示逆时针是洞
\item<3-> Polygons类的\emphText{plotOrder}属性用来处理复杂面集合的绘制顺序
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{rcode}
> getClass("Polygon")
Class "Polygon" [package "sp"]

Slots:
                                              
Name:    labpt    area    |\colorbox{green}{hole}| |\colorbox{green}{ringDir}|  coords
Class: numeric numeric logical integer  matrix

Extends: "Line"
> getClass("Polygons")
Class "Polygons" [package "sp"]

Slots:
                                                        
Name:   Polygons |\colorbox{green}{plotOrder}     labpt        ID      area
Class:      list   integer   numeric character   numeric
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<2>
\begin{rcode}
# 加载一个包含洞对象和岛对象的数据
> load("data/high.RData")
> manitoulin_sp <- high$SP
# 数据只有一个Polygons
> length(manitoulin_sp@polygons)
> 1
# Polygons中包含19个Polygon
> str(manitoulin_sp@polygons[[1]],max.level=2)
Formal class 'Polygons' [package "sp"] with 5 slots
  ..@ Polygons :List of 19
  ..@ plotOrder: int [1:19] 1 2 3 4 18 17 19 5 6 7 ...
  ..@ labpt    : num [1:2] 278 46
  ..@ ID       : chr "2"
  ..@ area     : num 0.694
# 19个Polygon中有4个洞，15个岛
> sapply(manitoulin_sp@polygons[[1]]@Polygons, function(x) slot(x, "hole"))
 [1] FALSE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
[13] FALSE FALSE FALSE FALSE  TRUE  TRUE  TRUE
> sapply(manitoulin_sp@polygons[[1]]@Polygons, function(x) slot(x, "ringDir"))
 [1]  1 -1  1  1  1  1  1  1  1  1  1  1  1  1  1  1 -1 -1 -1
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{figure}[ht] \vspace{-20pt}
  \includegraphics[width=0.6\columnwidth]{spatial_polygons_example2.pdf}
  \caption{先绘制大陆，接着是湖，然后是岛，最后是岛上的湖}
\end{figure}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\subsubsection{栅格数据类}
\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> sp包除了矢量数据，还提供了SpatialGrid类和SpatialPixel类用于表达栅格数据
\item<2-> \emphText{GridTopology}类用于表达基本的网格对象，\emphText{SpatialGrid}类在此基础上继承了Spatial类，使其具有bbox和CRS属性
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<2>
\begin{rcode}
# 通过左下角网格中心点坐标、网格尺寸和网格数目三个属性来定义基本网格
> getClass("GridTopology")
Class "GridTopology" [package "sp"]

Slots:
                                                            
Name:  |\colorbox{green}{cellcentre.offset}|          |\colorbox{green}{cellsize}|         |\colorbox{green}{cells.dim}|
Class:           numeric           numeric           integer
# 定义一个bbox范围
> b <- bbox(manitoulin_sp)
> bb
    min   max
x 277.0 278.0
y  45.7  46.2
# 定义左小角中心点坐标和网格尺寸
> cs <- c(0.01, 0.01)
> cc <- bb[,1]+(cs/2)
# 定义x和y两个方向的网格数目
> cd <- ceiling(diff(t(bb))/cs)
# 创建一个GridTopology对象
> manitoulin_grd <- GridTopology(cellcentre.offset=cc, cellsize=cs, cells.dim=cd)
> manitoulin_grd
                        x      y
cellcentre.offset 277.005 45.705
cellsize            0.010  0.010
cells.dim         100.000 50.000
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{rcode}
> getClass("SpatialGrid")
Class "SpatialGrid" [package "sp"]

Slots:
                                             
Name:          grid         bbox  proj4string
Class: GridTopology       matrix          CRS

Extends: "Spatial"

Known Subclasses: "SpatialGridDataFrame"
> p4s <- CRS(proj4string(manitoulin_sp))
# 创建SpatialGrid对象
> manitoulin_SG <- SpatialGrid(manitoulin_grd, proj4string=p4s)
> summary(manitoulin_SG)
Object of class SpatialGrid
Coordinates:
    min   max
x 277.0 278.0
y  45.7  46.2
Is projected: FALSE 
proj4string :
[+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0]
Grid attributes:
  cellcentre.offset cellsize cells.dim
x           277.005     0.01       100
y            45.705     0.01        50
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<4>
\begin{figure}[ht] \vspace{-10pt}
  \includegraphics[width=\columnwidth]{spatial_grid_example1.pdf}
\end{figure}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> sp包提供\emphText{SpatialGridDataFrame}类将SpatialGrid对象转换为类似data.frame数据结构，用于挂载网格上的属性，例如高程、温度、风力、颜色等
\item<1-> SpatialGridDataFrame类的data属性\emphText{存储完整网格的全部属性数据}，包括NA值的
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{rcode}
# 读取一个Geotiff格式栅格数据数据到SpatialGridDataFrame对象auck\_el1
> library(rgdal)
> auck_el1 <- readGDAL("data/70042108.tif")
# 对象是由1320*1200的维度构成
> auck_el1@grid
                             x             y
cellcentre.offset 1.742004e+02 -3.749958e+01
cellsize          8.333333e-04  8.333333e-04
cells.dim         1.320000e+03  1.200000e+03
# data存储了完整的1584000个网格的属性数据
> str(auck_el1,max.level=2)
Formal class 'SpatialGridDataFrame' [package "sp"] with 4 slots
  ..@ data       :'data.frame': 1584000 obs. of  1 variable:
  ..@ grid       :Formal class 'GridTopology' [package "sp"] with 3 slots
  ..@ bbox       : num [1:2, 1:2] 174.2 -37.5 175.3 -36.5
  .. ..- attr(*, "dimnames")=List of 2
  ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
# data属性只有一个band1字段,表示海拔高程;将高程等于或者小于0米的网格设置为NA
> str(auck_el1@data)
'data.frame':   1584000 obs. of  1 variable:
 $ band1: num  40 45 42 34 42 59 79 99 113 127 ... 
> is.na(auck_el1$band1) <- auck_el1$band1 <= 0
> summary(auck_el1$band1)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
    1.0    23.0    53.0    78.1   106.0   686.0  791938 
\end{rcode}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> sp包还提供了\emphText{SpatialPixels}类实现另一种栅格数据表达；与SpatialGrid相比，SpatialPixels
增加了\emphText{grid.index}和\emphText{coords}属性，分别用于存储网格索引和中心点坐标
\item<2-> 一个好处是在\emphText{SpatialPixelsDataFrame}类中\emphText{只存储非NA值的网格属性}，
可以减小data属性的存储空间和处理时间
\item<2-> 另一个好处是可以\emphText{将栅格数据以空间点存储在外部数据库中}，也可以由空间点类创建栅格数据
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<1>
\begin{rcode}
> getClass("SpatialPixels")
Class "SpatialPixels" [package "sp"]

Slots:
                                                                       
Name:          grid   |\colorbox{green}{grid.index}|       |\colorbox{green}{coords}|         bbox  proj4string
Class: GridTopology      integer       matrix       matrix          CRS

Extends: 
Class "SpatialPoints", directly
Class "Spatial", by class "SpatialPoints", distance 2

Known Subclasses: "SpatialPixelsDataFrame"
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<2>
\begin{rcode}
# 转换为SpatialPixelsDataFrame类
> auck_el2 <- as(auck_el1, "SpatialPixelsDataFrame")
# 由于data属性只存储非NA值,因此只有792062维度
# grid.index属性用于网格索引,只存储非NA值网格的序号
# coords属性可以和SpatialPoints类互相转换适合在外部数据库中存储
> str(auck_el2, max.level=2)
Formal class 'SpatialPixelsDataFrame' [package "sp"] with 7 slots
  ..@ data       :'data.frame': 792062 obs. of  1 variable:
  ..@ coords.nrs : num(0) 
  ..@ grid       :Formal class 'GridTopology' [package "sp"] with 3 slots
  ..@ |\colorbox{green}{grid.index}| : int [1:792062] 1 2 3 4 5 6 7 8 9 10 ...
  ..@ |\colorbox{green}{coords}|     : num [1:792062, 1:2] 174 174 174 174 174 ...
  .. ..- attr(*, "dimnames")=List of 2
  ..@ bbox       : num [1:2, 1:2] 174.2 -37.5 175.3 -36.5
  .. ..- attr(*, "dimnames")=List of 2
  ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{rcode}
# SpatialPixelsDataFrame减少了data属性存储空间
> object.size(auck_el1@data)
12672672 bytes
> object.size(auck_el2@data)
9505408 bytes

# 虽然data不用存储NA值,但是SpatialPixelsDataFrame需要额外存储coords和gird.index,
# 所以如果属性很少,而且非NA值比例不高的情况下,反而占的空间比较大
> object.size(auck_el1) # SpatialGridDataFrame不用存储coords和grid.index
12676296 bytes
> object.size(auck_el2@grid.index) # grid.index另外占用空间
3168288 bytes
> object.size(auck_el2@coords) # coords另外占用空间
12673512 bytes
# 占用空间几乎是SpatialGridDataFrame的二倍,但是在处理速度上由于有grid.index索引,
# 因此比SpatialGridDataFrame要快
> object.size(auck_el2) 
25351272 bytes
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<4>
\begin{figure}[ht] \vspace{-20pt}
  \includegraphics[width=\columnwidth]{spatialpixelsdataframe_class.png}
\end{figure}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> sp包处理栅格数据的方式是将所有数据一次性读入内存，但是这样对于大数据量可能会导致内存溢出，因此
从2010年开始CRAN发布了\emphText{raster包}，可以将栅格数据分块读入内存
\item<2-> raster包提供\emphText{raster函数}值将参数读入内存创建\emphText{RasterLayer}对象，而并不读入网格数据；
当需要读取数据到内存时，则调用\emphText{getValues}或\emphText{extract}函数

\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<2>
\begin{rcode}
> library(raster)
# 读取栅格文件数据到RasterLayer对象
> r <- raster("data/70042108.tif")
# RasterLayer对象只存储数据的参数，包括维度、分辨率、范围、CRS、文件路径和名称
> r
class       : RasterLayer 
dimensions  : 1200, 1320, 1584000  (nrow, ncol, ncell)
resolution  : 0.0008333333, 0.0008333333  (x, y)
extent      : 174.2, 175.3, -37.5, -36.5  (xmin, xmax, ymin, ymax)
coord. ref. : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
data source : /home/mono/Documents/tex_projects/r_guide_slide/data/70042108.tif 
names       : X70042108
# 并没有将网格数据读入内存，因此只占用很小的空间
> inMemory(r)
[1] FALSE
> object.size(r)
12032 bytes
# 用getValues函数将所有网格数据读入内存
> rs <- getValues(r)
> object.size(rs)
12672040 bytes
\end{rcode}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> RasterLayer只能表达一个属性的栅格数据，而有多个属性时，则可以在相同的空间范围和分辨率网格中叠加存储数据，raster包提供了\emphText{brick}和\emphText{stack}两个函数来实现
\item<2-> brick函数读入一个包含多层栅格数据的文件，而stack函数读入多个只包含一层栅格数据的文件；brick函数创建
\emphText{RasterBrick}对象，而stack函数创建\emphText{RasterStack}对象
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<2>
\begin{rcode}
> library(raster)
# 读取并创建一个RasterLayer对象
> data <- system.file("external/test.grd", package="raster")
> r1 <- raster(data) 
> nlayers(r1)  # r1对象只包含一层数据，也就是一个属性
[1] 1
# 创建第二个RasterLayer对象
> r2 <- r1 * r1
# 创建第三个RasterLayer对象
> r3 <- sqrt(r1)
# 三个具有相同空间范围和分辨率的RasterLayer对象通过stack函数叠加后创建RasterStack对象
> s <- |\colorbox{green}{stack}|(r1,r2,r3)
> s # 创建的RasterStack对象包括三个数据层
class       : RasterStack 
dimensions  : 115, 80, 9200, 3  (nrow, ncol, ncell, nlayers)
resolution  : 40, 40  (x, y)
extent      : 178400, 181600, 329400, 334000  (xmin, xmax, ymin, ymax)
coord. ref. : +init=epsg:28992 +towgs84=565.237,50.0087,465.658,-0.406857,0.350733,-1.87035,4.0812 +proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +no_defs 
names       :         |\colorbox{green}{test}|,      |\colorbox{green}{layer.1}|,      |\colorbox{green}{layer.2}| 
min values  :    128.43401,  16495.29383,     11.33287 
max values  : 1.805780e+03, 3.260842e+06, 4.249447e+01 
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{figure}[ht] 
  \includegraphics[width=\columnwidth]{spatial_raster_example1.pdf}
\end{figure}
\end{onlyenv}

\begin{onlyenv}<4>
\begin{rcode}
# 读取一个包含多层数据的栅格文件
> b <- |\colorbox{green}{brick}|(system.file("external/rlogo.grd", package="raster"))
# brick函数创建的RasterBrick对象
> b
class       : RasterBrick 
dimensions  : 77, 101, 7777, 3  (nrow, ncol, ncell, nlayers)
resolution  : 1, 1  (x, y)
extent      : 0, 101, 0, 77  (xmin, xmax, ymin, ymax)
coord. ref. : +proj=merc +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 
data source : /home/mono/Softwares/R/3.4/raster/external/rlogo.grd 
names       : red, green, blue 
min values  :   0,     0,    0 
max values  : 255,   255,  255 
# RasterBrick对象包含三层数据
> nlayers(b)
[1] 3
# 三层数据对应的三个属性
> names(b)
[1] "red"   "green" "blue" 
\end{rcode}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> raster包提供\emphText{blockSize}函数对栅格数据进行分块，分块按照整行读取，根据行数确定分块大小
\item<1-> \emphText{writeValues}函数将分块数据写入文件，
\emphText{writeStart}和\emphText{writeStop}函数则控制此写入过程的起始和终止
\end{itemize}

\begin{overlayarea}{\textwidth}{\textheight}
\begin{onlyenv}<2>
\begin{rcode}
> out <- raster("data/70042108.tif")
> bs <- |\colorbox{green}{blockSize}|(out)
> bs # 默认分块数为4,row是每块起始的行号,nrows是每个分块的行数
$row
[1]   1 301 601 901
$nrows
[1] 300 300 300 300
$n
[1] 4
# 开始写入操作,创建一个临时文件
> out <- |\colorbox{green}{writeStart}|(out, filename=tempfile(), overwrite=TRUE)
> for (i in 1:bs$n) {
+     v <- getValues(r, row=bs$row[i], nrows=bs$nrows[i]) # 读取分块数据
+     v[v <= 0] <- NA # 分块中高程小于或等于0米的数据设置为NA值
+     |\colorbox{green}{writeValues}|(out, v, bs$row[i])} # 将分块数据写入临时文件
# 结束写入操作,释放文件锁
> out <- |\colorbox{green}{writeStop}|(out) 
> out  # 从data source可以看到写入文件的位置
class       : RasterLayer 
dimensions  : 1200, 1320, 1584000  (nrow, ncol, ncell)
resolution  : 0.0008333333, 0.0008333333  (x, y)
extent      : 174.2, 175.3, -37.5, -36.5  (xmin, xmax, ymin, ymax)
coord. ref. : +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 
|\colorbox{green}{data source}| : /tmp/RtmpNPhsrD/file177423e63b141.grd 
names       : layer 
values      : NA, NA  (min, max)
\end{rcode}
\end{onlyenv}

\begin{onlyenv}<3>
\begin{figure}[ht] \vspace{-15pt}
  \includegraphics[width=0.65\columnwidth]{spatial_raster_example2.pdf}
\end{figure}
\end{onlyenv}
\end{overlayarea}
\end{frame}

\begin{frame}[t,fragile]{\subsecname}{\subsubsecname}
\begin{itemize}
\item<1-> sp包和raster包的栅格数据类可以互相转换，例如RasterLayer对象可以强制转换为SpatialGridDataFrame对象，
反之亦可
\end{itemize}

\begin{rcode}
> # RasterLayer对象转换为SpatialGridDataFrame对象
> r1 <- as(out, "SpatialGridDataFrame")
> str(r1, max.level=2)
Formal class 'SpatialGridDataFrame' [package "sp"] with 4 slots
  ..@ data       :'data.frame': 1584000 obs. of  1 variable:
  ..@ grid       :Formal class 'GridTopology' [package "sp"] with 3 slots
  ..@ bbox       : num [1:2, 1:2] 174.2 -37.5 175.3 -36.5
  .. ..- attr(*, "dimnames")=List of 2
  ..@ proj4string:Formal class 'CRS' [package "sp"] with 1 slot

> # SpatialGridDataFrame转换为RasterLayer对象
> r2 <- as(r1, "RasterLayer")
> str(r2, max.level=2)
Formal class 'RasterLayer' [package "raster"] with 12 slots
  ..@ file    :Formal class '.RasterFile' [package "raster"] with 13 slots
  ..@ data    :Formal class '.SingleLayerData' [package "raster"] with 13 slots
  ..@ legend  :Formal class '.RasterLegend' [package "raster"] with 5 slots
  ..@ title   : chr(0) 
  ..@ extent  :Formal class 'Extent' [package "raster"] with 4 slots
  ..@ rotated : logi FALSE
  ..@ rotation:Formal class '.Rotation' [package "raster"] with 2 slots
  ..@ ncols   : int 1320
  ..@ nrows   : int 1200
  ..@ crs     :Formal class 'CRS' [package "sp"] with 1 slot
  ..@ history : list()
  ..@ z       : list()
\end{rcode}
\end{frame}
\subsection{空间数据的导入导出}

\subsection{空间数据可视化}